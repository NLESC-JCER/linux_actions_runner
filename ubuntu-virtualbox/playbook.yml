---
- hosts: all
  vars:
    RUNNER_VERSION: 2.169.1
  vars_files:
    - secret.yml
  vars_prompt:
    - name: ORG
      prompt: What is the GitHub organization associated with this self-hosted runner?
      private: no
    - name: REPO
      prompt: What is the GitHub repository associated with this self-hosted runner?
      private: no
    - name: RUNNER_NAME
      prompt: What is the runner's name on GitHub?
      private: no
      default: github-action-runner

  tasks:
    - name: Verify that user exists on the server
      become: yes
      user:
        name: "{{ ansible_user }}"
        groups: sudo,adm
        state: present

    - name: Showing the input variables
      debug:
        msg: "Setting up a GitHub runner {{ RUNNER_NAME }} for repository: https://github.com/{{ ORG }}/{{ REPO }}"

    - name: Only run "apt update-cache" if the last one is more than 3600 seconds old
      become: yes
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install jq
      become: yes
      apt:
        name:
          - jq
          - curl
        state: present

    - name: Requesting registration
      shell:
        cmd: "curl -sX POST -H \"Authorization: token {{ PERSONAL_ACCESS_TOKEN }}\" \"https://api.github.com/repos/{{ ORG }}/{{ REPO }}/actions/runners/registration-token\" | jq .token --raw-output"
      register: CURL_OUTPUT
      tags:
        - uninstall
      args:
        warn: false

    - name: Creating a directory for the runner
      file:
        path: /home/tester/opt/actions-runner/{{ ORG }}/{{ REPO }}/{{ RUNNER_NAME }}
        state: directory

    - name: Downloading and extracting the runner
      unarchive:
        src: https://github.com/actions/runner/releases/download/v{{ RUNNER_VERSION }}/actions-runner-linux-x64-{{ RUNNER_VERSION }}.tar.gz
        dest: /home/tester/opt/actions-runner/{{ ORG }}/{{ REPO }}/{{ RUNNER_NAME }}
        creates: /home/tester/opt/actions-runner/{{ ORG }}/{{ REPO }}/{{ RUNNER_NAME }}/config.sh
        remote_src: yes

    - name: Configuring the GitHub Action runner
      shell:
        chdir: /home/tester/opt/actions-runner/{{ ORG }}/{{ REPO }}/{{ RUNNER_NAME }}
        cmd: ./config.sh --url https://github.com/{{ ORG }}/{{ REPO }} --name {{ RUNNER_NAME }} --token {{ CURL_OUTPUT.stdout }} --unattended --replace

    - name: Install the GitHub Action runner as a service
      become: yes
      shell:
        chdir: /home/tester/opt/actions-runner/{{ ORG }}/{{ REPO }}/{{ RUNNER_NAME }}
        cmd: ./svc.sh install

    - name: Enable starting the runner service when the machine starts
      become: yes
      shell: systemctl enable actions.runner.{{ ORG }}-{{ REPO }}.{{ RUNNER_NAME }}.service
      tags:
        - enable

    - name: Starting the runner service
      become: yes
      shell: systemctl start actions.runner.{{ ORG }}-{{ REPO }}.{{ RUNNER_NAME }}.service
      tags:
        - start

    - name: Stopping the runner service
      become: yes
      shell: systemctl stop actions.runner.{{ ORG }}-{{ REPO }}.{{ RUNNER_NAME }}.service
      tags:
        - never
        - stop

    - name: Disable starting the runner service when the system boots
      become: yes
      shell: systemctl disable actions.runner.{{ ORG }}-{{ REPO }}.{{ RUNNER_NAME }}.service
      tags:
        - never
        - disable

    - name: Restart the runner service
      become: yes
      shell: systemctl restart actions.runner.{{ ORG }}-{{ REPO }}.{{ RUNNER_NAME }}.service
      tags:
        - never
        - restart

    - name: Show the runner service status
      become: yes
      shell: systemctl status actions.runner.{{ ORG }}-{{ REPO }}.{{ RUNNER_NAME }}.service
      tags:
        - never
        - status

    - name: Unregister the runner with GitHub
      become: yes
      shell:
        chdir: /home/tester/opt/actions-runner/{{ ORG }}/{{ REPO }}/{{ RUNNER_NAME }}
        cmd: ./svc.sh uninstall
      tags:
        - never
        - uninstall

    - name: Unregister the runner with GitHub and uninstall the runner service
      shell:
        chdir: /home/tester/opt/actions-runner/{{ ORG }}/{{ REPO }}/{{ RUNNER_NAME }}
        cmd: ./config.sh remove --token {{ CURL_OUTPUT.stdout }}
      tags:
        - never
        - uninstall
